## 设计总体纲领

---

**根据比赛策略设计，1号机器人可能面临的情景有：**

- **高台抢占与防守**：与对方机器人在中央高台进行对抗，具备较强的挤压与抗挤压能力。
- **弹丸接收**：高效承接从中央高台下落的弹丸。
- **弹丸转运**：安全、稳定地接收来自2号机器人的弹丸。
- **战术干扰**：具备干扰对方机器人行动的能力。

**由此可知，1号机器人所需要的核心功能如下：**

- 挤压排斥能力
- 弹丸承接能力
- 弹丸转移能力
- 弹丸存储能力
- 桥梁通行能力

---

## 硬件系统设计

---

**为实现以上功能，对1号机器人的模块设计如下：**

- 履带底盘模块
    
- 主体弹舱模块
    
- 排斥铲斗模块
    
- 承接漏斗模块
    
- 转移舱门模块
    
- 磁吸对接模块
    
- 桥梁纠偏模块
    
- （新增）动力系统模块
    

**硬件电路拓扑图：**

#### 模块开发日志

- **2025.10.4**：完成1号机器人硬件电路拓扑图的初步绘制。
    

---

### 动力系统模块

为给所有机动和操作提供稳定、持久的能源，平衡电池容量、电压稳定性、输出电流和成本，决定：

- **驱动瓶颈分析**：鉴于L298N驱动板单路持续电流仅2A，而机器人TT马达在负载（如推挤、爬坡）情况下瞬时电流可能超过4A，L298N成为系统瓶颈。
    
- **电芯选型**：对比Molicel P28A（成本过高）、三星30Q、村田VTC6和三星25R后，选择**三星30Q**。其在10A-15A放电区间表现出最佳的电压稳定性和容量保持率，且成本适中，能在比赛周期内提供最平稳的动力输出。
    
- **电池组方案**：采用**3节三星30Q电芯组成3S电池组（11.1V）**，在满足电机额定电压的同时，提供足够的动力储备。
    
- **电池管理系统 (BMS)**：配备**20A持续放电能力的BMS**，为L298N驱动板提供了超过4倍的安全裕量，有效防止过流、过放和短路风险。
    
- **接线与连接器**：所有主电源线路均采用**16AWG硅胶线**，并使用**XT60接插件**，以确保低电阻和可靠连接，减少功率损耗和发热。
    

### 履带底盘模块

为实现强大的挤压排斥能力和稳定的机动性，决定：

- 为获最大抓地力，选用**橡胶材质履带**。
    
- 为保障动力，采用两颗 **33GB-520 电机** 独立驱动，搭配 **L298N 驱动板** 进行控制。
    
- 底盘主体采用 **PLA 3D 打印件** 作为结构框架，在保证结构强度的同时，有效控制了成本与重量。
    
- 为确保通过桥梁时的稳定性，两履带中心面间距设计为 **20cm**。
    
- 底盘内部设计了独立的硬件舱，用于收纳主控板、电池、驱动板等电控元件，便于布线与维护。
    

#### 模块开发日志

- **2025.10.7**：完成履带底盘模块的基本设计与选材。
    
- **2025.10.12**：完成履带底盘模块的建模。
    

### 主体弹舱模块

为实现大容量的弹丸存储能力，综合考虑成本、重量限制、强度要求和制作难度，决定：

- 采用 **10mm×10mm 的 PLA 打印件** 作为弹仓的整体框架。
    
- 采用 **孔径为 7mm 的无结尼龙网** 包裹框架作为承接面，以减轻重量并保证弹丸不会漏出。
    
- 采用束线带及紧固件作为承接面与框架之间的连接件，便于安装和更换。
    
- 考虑弹丸容量和体积限制，弹仓尺寸设计为 **150mm×150mm×200mm**。
    

#### 模块开发日志

- **2025.10.7**：完成主体弹舱模块的基本设计与选材。
    
- **2025.10.12**：完成主体弹舱模块的建模。
    

### 排斥铲斗模块

为在挤压对抗中获得优势，使机器人在挤压和抵抗挤压时取得优势，决定：

- 在机器人前方设置一个 **弧面楔形** 铲斗，能够在挤压和被挤压时，通过改变接触角度来获得力学优势。
    
- 考虑定制化需求、强度、成本和重量限制，采用 **PLA 3D 打印件** 作为主要材料。
    

#### 模块开发日志

- **2025.10.7**：完成排斥铲斗模块的基本设计与选材。
    
- **2025.10.13**：完成排斥铲斗模块的建模。
    

### 承接漏斗模块

为高效接收从上方下落的大量弹丸，并具备伸缩功能以适应不同赛况，决定：

- 在主体弹仓模块中靠前位置设置一个可伸缩管道，结构与材料设计基本与主题弹仓模块相同。
    
- 采用两个 **N20 电机** 结合 **齿轮-齿条结构** 实现漏斗的垂直升降功能。
    
- 搭配两个 **直柄碰撞传感器** 作为行程开关，实现升降过程的限位自停，防止机械结构损坏。
    
- 管道顶部设有一个由四根结构杆撑起的 **网状漏斗**，关节处设有扭转弹簧。
    
- 漏斗在收纳状态下与管道平行；伸出后，弹簧复位使其向外张开呈漏斗状，以增大弹丸接收面积。
    

#### 模块开发日志

- **2025.10.7**：完成承接漏斗模块的基本设计与选材。
    
- **2025.10.13**：完成承接漏斗模块的建模。
    

### 转移舱门模块

为接收由2号机器人收集的弹丸，实现高效稳定的对接，决定：

- 在主体弹仓模块后方偏上的位置设有一个由 **SG90 舵机** 控制开合的舱门。
    
- 为使转移过程高效稳定，舱门模块的位置及尺寸与2号机器ンの翻斗弹仓模块相适应。
    
- 考虑定制化要求，采用 **PLA 3D 打印件** 作为主要材料。
    

#### 模块开发日志

- **2025.10.7**：完成转移舱门模块的基本设计与选材。
    
- **2025.10.14**：完成转移舱门模块的建模。
    

### 磁吸对接模块

为提升弹丸转移过程的稳定性和抗干扰能力，决定：

- **初始方案**：在主体弹仓模块后方中部位置外侧设L型的活动件，利用磁铁吸附形成侧向互锁结构。
    
- **迭代优化（2025.10.13更新）**：由于设计空间有限，原方案过于复杂。现将磁吸对接模块简化为 **凹凸圆锥形** 结构，在圆锥顶面设置磁铁圆片。靠近时，两个圆锥结构能够自动对正并吸附，实现快速、稳定的对接。
    
- 考虑定制化要求，采用 **PLA 3D 打印件** 作为主要材料。
    

#### 模块开发日志

- **2025.10.7**：完成磁吸对接模块的初始设计与选材。
    
- **2025.10.13**：基于空间限制，对模块进行简化设计，并完成建模。
    

### 桥梁纠偏模块

为使1号机器人能迅速通过桥梁抢占高台，提升经过桥梁期间的稳定性，防止掉落，决定：

- 在排斥铲斗模块的下方设置两个横向间隔 **14.5cm**，方向向下的 **KW8-3 碰撞传感器**，用以检测此处的实体存在性。
    
- 传感器碰撞末端设有小型导轮，兼具双重功能：
    
    - **辅助轮作用**：下方存在实体时，传感器受到压力而收回，导轮起到辅助支撑作用。
        
    - **侧向限位作用**：下方不存在实体时，传感器伸出，触发纠偏逻辑，同时在物理上起到一定的限位作用。
        

#### 模块开发日志

- **2025.10.7**：完成桥梁纠偏模块的基本设计与选材。
    

---

## 软件与控制系统

---

### 系统架构与技术选型

为保证系统实时性和稳定性，协调处理高频输入、电机控制和紧急避障等多重任务，决定：

- **硬件平台**：STM32F103C8T6 (ST-Link V2)
    
- **开发工具**：STM32CubeMX + VSCode + EIDE + OpenOCD + Cortex-Debug
    
- **操作系统选型**：
    
    - 鉴于裸机轮询难以保证多任务实时性，而机器人需同时处理 **50Hz 的手柄输入**、**100Hz 的电机控制** 和 **高优先级的碰撞检测**。
        
    - 决定采用 **FreeRTOS**，利用其任务优先级和队列通信机制，确保关键任务（如碰撞检测）的优先执行。
        
- **PS2 通信方式选型**：
    
    - 对比 **软件 GPIO**（配置灵活但CPU开销大）和 **硬件 SPI**（硬件处理，性能消耗小）。
        
    - 为在 FreeRTOS 多任务环境下节省 CPU 资源，并满足高频轮询需求，决定采用 **硬件 SPI** 方案。
        

### 核心功能实现

#### 1. PS2 远程控制

为实现稳定读取手柄数据，并将摇杆与按键信息实时解析，通过队列发送给相应任务，决定：

- **任务设计**：设置 `ps2Task` 任务，优先级为 `AboveNormal`，确保输入响应及时性。
    
- **SPI 模式**：针对双灯版 PS2，将 SPI 模式配置为 **CPHA = 2 Edge**，以解决初始配置（CPHA=1Edge）导致的通信不稳定问题。
    
- **数据解析**：将摇杆原始数据 0–255 映射到 **-128 ~ +127** 的范围，0点居中，便于进行速度和方向的计算。
    
- **数据流（队列）**：
    
    - 摇杆数据 → `motorQueue01` (底盘电机)
        
    - L1/L2 肩键 → `servoQueue` (转移舱门)
        
    - R1/R2 肩键 → `motorQueue02` (承接漏斗)
        
    - 〇 键 → `lockModeQueue` (防挤压驻守)
        

#### 2. 双电机驱动与差速转向

为实现左右履带的独立控制，支持差速转向，并避免惯性滑行，决定：

- **PWM 控制**：使用 TIM 输出 **1kHz** 的 PWM 信号驱动 L298N，该频率可有效避免电机啸叫。
    
- **主动刹车逻辑**：当摇杆回中（速度指令为0）时，将对应的 IN1 和 IN2 引脚同时置为高电平，形成 **短路制动**。这使得电机立即停止，极大提升了操控精度。
    
- **摇杆死区**：设置 **±10** 的摇杆死区，避免因手柄摇杆的物理抖动导致电机产生不必要的微动。
    

#### 3. 转移舱门舵机控制

为实现后舱门的连续开合控制，并防止逻辑冲突，决定：

- **PWM 输出**：使用 TIM1 CH1 输出 **50Hz** 的 PWM 信号控制 SG90 舵机。
    
- **角度映射**：将 0° 映射为 0.5ms 脉宽，180° 映射为 2.5ms 脉宽。
    
- **控制优化**：由单次触发改为 **长按时持续转动**（每 10ms 调整 2°）。
    
- **冲突保护**：当 L1 和 L2 被同时按下时，判定为逻辑冲突，舵机停止动作。
    

#### 4. 实体碰撞检测与桥梁纠偏

为实现通过桥梁时的高优先级自动纠偏，防止掉落，并解决因机械结构带来的严重物理抖动问题，决定：

- **防抖方案**：弃用易受物理抖动干扰的 GPIO EXTI 中断方案。
    
- 改为采用 **10ms 软件轮询**，并结合 **50ms 的防抖计时**（即连续 5 次检测到相同状态后才确认状态有效），以此有效过滤抖动干扰。
    
- **硬件逻辑**：根据微动开关的 **NO (Normally Open)** 特性（常开型），修正软件中的判断条件。
    
- **平滑纠偏**：为避免纠偏动作卡顿和剧烈冲击，引入 **“目标速度 + 平滑过渡”** 算法。
    
    - 检测到悬空时，将目标速度设定为原速度的 **40%**（经过60%→30%→40%实测对比的最佳值）。
        
    - 每 10ms 将当前速度向目标速度调整 **12%**（经过5%→20%→12%测试的最佳平衡步长），使减速过程变得平滑，车体姿态更稳定。
        

#### 5. 防挤压驻守模式（圆圈键锁止）

为实现在高台等关键位置驻守时能抵抗外力推动，并兼顾平滑性、低能耗与低噪音，决定：

- **方案迭代**：
    
    - 弃用 v1.0（5Hz 瞬间正反转）：机械冲击剧烈，噪音极大，损害结构。
        
    - 弃用 v1.1（2Hz 平滑过渡）：冲击减小，但缺少“锁止”感，效果不佳。
        
- **最终方案 (v2.0)**：采用 **三阶段平滑控制**，将一个完整的锁止周期（2秒）分为三个阶段，模拟“对抗-释放-再对抗”的节奏：
    
    - **加速 → 减速 → 零速停留**
        
- **技术实现**：
    
    - 使用 `lockPhase` 状态机追踪阶段，并通过线性插值确保速度变化平滑。
        
    - 为降低能耗和噪音，将最大速度限制在 **±64**（约50%功率）。
        
    - 在每个周期的末尾增加一个 **500ms** 的零速停留阶段，以释放机械应力，提升锁止稳定性。
        
- **逻辑优先级**：该功能由〇键触发，拥有最高优先级，会覆盖摇杆输入。
    

---

## 四、系统集成与性能评估

---

### 4.1 系统资源占用

|**资源类型**|**使用量**|**总量**|**占用率**|**说明**|
|---|---|---|---|---|
|**RAM**|6.8 KB|20 KB|34.0%|包含任务栈、FreeRTOS 堆及全局变量，余量充足。|
|**任务数**|5|-|-|`ps2Task`, `servoTask`, `motorTask01`, `motorTask02`, `collisionTask01`|
|**队列数**|3|-|-|`motorQueue01`, `motorQueue02`, `servoQueue`|

**分析**：系统资源利用率均衡，RAM 占用在安全范围内，为后续功能扩展留有余地。

### 4.2 实时性与响应速度

|**功能模块**|**周期/频率**|**响应时间**|**说明**|
|---|---|---|---|
|**PS2 数据采样**|20ms / 50Hz|< 25ms|保证输入无明显延迟。|
|**电机控制**|10ms / 100Hz|< 15ms|控制平滑，无抖动。|
|**舵机控制**|10ms / 100Hz|< 20ms|连续转动，响应及时。|
|**碰撞检测**|10ms 轮询 + 50ms 防抖|< 60ms|足够在掉落前完成纠偏。|
|**停车响应**|-|< 50ms|主动刹车效果显著，定位精准。|
|**圆圈键锁止**|2s 周期|< 10ms|状态切换迅速，过渡平滑。|

**分析**：所有关键任务均在 100ms 内响应，满足实时性要求。主动刹车和碰撞检测的优化，极大地提升了机器人的操控性和安全性。

### 4.3 控制精度与操纵体验

- **摇杆死区**：**±10** 的死区设定有效过滤了手柄摇杆的物理抖动。
    
- **电机平滑过渡**：**12%/10ms** 的速度调整步长，使得加速和减速过程自然流畅。
    
- **自动纠偏**：通过差速实现自然转向，无需停车，整个过程一气呵成。
    
- **圆圈键锁止**：三阶段控制策略在保证锁止效果的同时，兼顾了平滑性和低能耗，体验良好。
    

---

## 五、总结与反思

---

### 5.1 成功经验

1. **FreeRTOS 的正确应用**：合理的任务划分和优先级设计是保证系统实时性的基石。
    
2. **平滑过渡算法的重要性**：在电机控制中（如纠偏和锁止）引入平滑过渡，是提升用户体验和保护机械结构的关键。
    
3. **轮询在特定场景下优于中断**：面对严重的物理抖动，带有软件防抖的轮询方案比硬件中断更可靠。
    
4. **迭代式开发**：从“能用”到“好用”的转变，离不开基于实际测试反馈的持续迭代。圆圈键锁止功能的四次迭代便是最佳例证。
    

### 5.2 不足与改进方向

1. **避障策略单一**：目前的纠偏策略仅支持减速转向，未来可加入后退、旋转等更复杂的避障动作。
    
2. **状态反馈缺失**：缺少 LED 或蜂鸣器等状态指示，为调试和使用带来不便。
    
3. **代码规范**：部分早期代码的注释和命名风格有待统一。
    

### 5.3 技术启示

- **确认硬件特性是前提**：如开关的 NO/NC 逻辑，错误的假设会导致整个软件逻辑的颠覆。
    
- **参数调优必须基于实测**：理论计算的参数（如纠偏比例）往往与实际表现有差距，唯有通过实验才能找到最佳值。
    
- **用户体验至上**：一个 50ms 的平滑过渡，或是一个 0.5s 的零速停留，这些看似微小的细节，却能极大地影响最终的操控感受。