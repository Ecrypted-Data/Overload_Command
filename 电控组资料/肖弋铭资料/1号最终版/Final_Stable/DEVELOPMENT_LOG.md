# 一号小车电控开发日志

**最后编辑时间**: 2025 年 10 月 23 日
**硬件平台**: STM32F103C8T6 （ ST-Link V2 )
**开发工具**: STM32CubeMX + VSCode + EIDE + OpenOCD + Cortex-Debug ( + Serial Monitor )

---

## 一、项目背景与目标

本项目旨在实现一号参赛小车的电控，具备以下功能：

1. **远程控制**：通过双灯版 PS2 控制小车进行一系列任务。
2. **后舱开合**：通过 L1/L2 控制舵机角度来控制舱门开合。
3. **履带运动**：通过 PS2 手柄左右摇杆独立控制左右电机，带动履带运动。
4. **路线纠偏**：通过两侧微动开关检测底部实体状态并自动调整行驶方向。
5. **顶部集球装置位移**：通过 R1/R2 控制顶部装置升降，并附带限位功能。

设计目标不仅是实现功能，还要保证 **实时性、稳定性和可扩展性**。因此在开发过程中，重点关注以下问题：

- 输入采样与电机控制的实时性
- 硬件接口的稳定性（SPI、PWM、GPIO）
- 系统任务调度与资源分配
- 操纵手控制（响应延迟、控制平滑性）

---

## 二、技术选型与设计取舍

### 2.1 操作系统：FreeRTOS vs 裸机

- **裸机轮询**：实现简单，但难以保证多任务实时性。
- **FreeRTOS**：支持任务优先级、队列通信，能更好地协调输入采样、电机驱动等控制逻辑。

**选择理由**： 由于机械臂需要同时处理 **50Hz 的手柄输入**、**100Hz 的电机控制** 和 **多个执行器的协调控制**，裸机实现会导致任务间抢占困难。FreeRTOS 的调度机制能保证关键任务优先执行，提升系统稳定性。

### 2.2 PS2 连接方式：软件 GPIO vs 硬件 SPI

| 方案 | 优点                       | 缺点                     | 适用性分析                                        |
| ---- | -------------------------- | ------------------------ | ------------------------------------------------- |
| GPIO | 已有现成驱动文件，配置灵活 | CPU 开销较大             | 适合快速开发，简易连接，不适合 CPU 资源紧张的情形 |
| SPI  | 性能消耗小                 | 现有教程不适配双灯版 PS2 | 适合单片机多任务情形                              |

**选择理由**：机械臂通过 FreeRTOS 处理五个任务，且 PS2 轮询频率较高，对 CPU 需求较大，选择 SPI 节省性能。

---

## 三、PS2 通信模块

### 3.1 设计目标

- 稳定读取手柄数据。
- 支持摇杆与按键的实时解析，数据发送到队列。

### 3.2 技术难点与解决方案

- **问题 1：SPI 模式错误**
  - 初始配置按照 PPT 教程进行，导致连接器绿灯慢闪（通信不稳定）。
  - 查阅资料后确认双灯版 PS2 需 **CPHA = 2 Edge** 。
  - 修改后通信稳定，连接控制正常。
- **问题 2：数据解析**
  - 摇杆范围为 0–255，不便于电机控制。
  - 解决方案：转换为 -128 ~ +127，便于差速计算。

### 3.3 FreeRTOS 任务设计

- **优先级**：AboveNormal，保证输入响应及时，同时低于纠偏任务的优先级。
- **数据流向**：
  - 摇杆数据 → motorQueue01
  - L1/L2 → servoQueue
  - R1/R2 → motorQueue02

---

## 四、舵机控制系统

### 4.1 设计目标

- 通过 L1/L2 按键实现舵机角度调节。
- 控制逻辑需支持连续转动与冲突保护。

### 4.2 技术实现

- 使用 TIM1 CH1 输出 50Hz PWM。
- 角度映射：0°→0.5ms，180°→2.5ms。

### 4.3 难点与优化

- **问题：按键单次触发导致控制不连续**
  - 改进：按住时持续转动，每 10ms 调整 2°。
- **问题：L1/L2 同时按下逻辑冲突**
  - 解决：检测到同时按下时停止动作。

---

## 五、双电机驱动系统

### 5.1 设计目标

- 左右电机独立控制，实现差速转向。
- 停止时需支持“主动刹车”，避免惯性滑行。

### 5.2 技术实现

- 驱动芯片：L298N，H 桥控制。
- PWM 频率：1kHz，避免电机啸叫。
- **主动刹车逻辑**：
  - speed=0 → IN1=HIGH, IN2=HIGH，形成短路制动。

### 5.3 优化措施

- 增加摇杆死区（±10），避免机械抖动导致电机微动。

---

## 六、实体碰撞检测与纠偏

### 6.1 设计目标

- 底部一侧无实体后另一侧电机自动减速来转向，避免掉落。
- 高优先级、快速相应的同时保证去抖。

### 6.2 技术难点与解决方案

- **问题 1：中断抖动严重**
  - 初始方案：GPIO EXTI 中断，结果抖动频繁。
  - 改进：改为 10ms 轮询 + 50ms 防抖，更稳定。
- **问题 2：逻辑反转**
  - 微动开关为 NO 型，导致逻辑与预期相反。
  - 解决：确认硬件特性后修正判断条件。
- **问题 3：减速卡顿**
  - 速度突变导致机械冲击。
  - 解决：引入“目标速度 + 平滑过渡”，每 10ms 调整 12%。

### 6.3 参数调优

- 减速比例：60% → 30% → **40%（最佳）**
- 平滑步长：5% → 20% → **12%（最佳）**

---

## 七、系统集成与调试

- **任务优先级**：碰撞检测最高，PS2 次高，电机与舵机为普通优先级。
- **队列大小**：根据采样周期与任务周期计算，避免数据积压或延迟。
- **实测性能**：
  - PS2 通信延迟：256µs
  - 碰撞响应：<60ms
  - 电机控制频率：100Hz

---

## 八、功能迭代与优化

### 8.1 电机锁死与主动刹车

- **问题**：原始设计摇杆回中时电机自由滑行，响应缓慢。
- **解决方案**：实现主动刹车逻辑（IN1=IN2=HIGH），停车响应时间从 ~300ms 降至 <50ms。
- **收益**：防止斜坡滑动，提升定位精度。

### 8.2 上部电机控制

- **新增 motorTask02**：R1/R2 控制顶部电机，支持正反转。
- **控制逻辑**：两按键同时按下时锁死，单独按下时满速运行，无按键时停止。

### 8.3 圆圈键锁止功能（2025 年 10 月最新）

**背景**：在实际操作中，需要小车在某些位置保持静止，不被外力推动。

**需求演变**：

1. **初版**（v1.0）：5Hz 瞬间正反转切换（200ms 周期）
   - 体验反馈：切换频率过快，冲击大，噪音大
2. **优化版**（v1.1）：2Hz 平滑过渡（2s 周期，1s 平滑）
   - 体验反馈：仅有加速和减速阶段，无"停顿"感
3. **改进版**（v1.2）：1Hz 持续过渡（1s 周期，全程平滑）
   - 体验反馈：更平滑但锁止感不足
4. **最终版**（v2.0）：三阶段平滑控制（2s 周期，速度 ±64）

**最终设计方案**：

| 参数     | 数值 | 说明                     |
| -------- | ---- | ------------------------ |
| 目标速度 | ±64  | 相对满速的 50%，降低冲击 |
| 阶段 1   | 0.5s | 加速阶段：0 → ±64        |
| 阶段 2   | 0.5s | 减速阶段：±64 → 0        |
| 阶段 3   | 0.5s | 停留阶段：保持 0 速度    |
| 周期     | 2s   | 完整一个方向的循环时间   |

**工作原理**：

```
时间轴（按住圆圈键）：
0s ──0.5s─> 1s ──0.5s─> 1.5s ──0.5s─> 2s ──0.5s─> 2.5s ──0.5s─> 3s
   0→+64     +64→0      保持0      0→-64      -64→0      保持0
   加速      减速       停留       加速       减速       停留
   ↑________________↑              ↑________________↑
     正转周期(2s)                    反转周期(2s)
```

**技术实现**：

- 状态机：三个阶段由 `lockPhase` 变量追踪（0=加速、1=减速、2=停留）
- 线性插值：每 10ms 更新一次速度值，确保平滑过渡
- 优先级：圆圈键为最高优先级，优先于摇杆和肩键

**优势对比**：

| 指标     | v1.0  | v1.1 | v1.2  | v2.0     |
| -------- | ----- | ---- | ----- | -------- |
| 冲击程度 | ★★★★★ | ★★★  | ★★    | ★★       |
| 平滑度   | ★     | ★★★  | ★★★★★ | ★★★★     |
| 锁止感   | ★★★★★ | ★★★★ | ★★★   | ★★★★     |
| 噪音     | 大    | 中   | 小    | 小       |
| 电耗     | 最高  | 中   | 中    | **最低** |

**参数优化过程**：

- 速度从 127 → 100 → 64：降低速度从而降低功率消耗和机械冲击
- 周期从 100ms → 2000ms → 2000ms：给机械系统充分时间反应
- 引入"零速停留"阶段：每 0.5s 给机械结构完全释放的时间

### 8.4 其他优化

- **代码优化**：统一注释风格、规范变量命名。
- **文档完善**：详细记录各功能的技术方案和参数调优过程。

---

## 九、性能总结

在完成所有功能开发与优化后，对系统的性能进行了量化评估。评估维度包括 **资源占用、实时性、响应速度、控制精度** 等。

### 9.1 系统资源占用（2025-11-07 更新）

| 资源类型 | 使用量 | 总量  | 占用率 | 说明                                                          |
| -------- | ------ | ----- | ------ | ------------------------------------------------------------- |
| RAM      | 6.5 KB | 20 KB | 33.0%  | 包含任务栈、FreeRTOS 堆、全局变量                             |
| 任务数   | 5      | -     | -      | ps2Task、servoTask、motorTask01、motorTask02、motorTask03 |
| 队列数   | 4      | -     | -      | motorQueue01、motorQueue02、motorQueue03、servoQueue                        |

**分析**：

- RAM 占用率约三分之一，主要消耗在任务栈和 FreeRTOS 堆上，合理分配后仍有余量。
- 系统整体资源利用率均衡，没有出现瓶颈。
- 相比早期版本，移除碰撞检测后RAM占用降低约0.5KB。

### 9.2 实时性与响应速度（2025-11-07 更新）

| 功能模块       | 周期/频率             | 响应时间  | 说明                           |
| -------------- | --------------------- | --------- | ------------------------------ |
| PS2 数据采样   | 20ms / 50Hz           | <25ms     | 保证输入无明显延迟             |
| 电机控制       | 10ms / 100Hz          | <15ms     | 足够平滑，避免抖动             |
| 舵机控制       | 10ms / 100Hz          | <20ms     | 连续转动，响应及时             |
| 停车响应       | 立刻                  | <50ms     | 主动刹车模式，显著优于自由滑行 |

**分析**：

- 关键任务均在 100ms 内完成，满足实时性要求。
- 电机锁死功能使停车响应时间缩短至 <50ms，显著提升了控制精度。
- 移除碰撞检测后，系统响应更快，任务调度更简洁。

### 9.3 控制精度与操纵方便度（2025-11-07 更新）

- **摇杆死区**：±10，有效避免了机械抖动导致的误触发。
- **电机平滑过渡**：12%/10ms 的调整步长，使减速/加速过程自然，无顿挫感。
- **舵机转速**：200°/s，0°→180° 约 0.9s，满足快速响应需求。
- **四方向约束**：前进/后退优先级高于转向，避免误操作，行驶更流畅。
- **开合电机控制**：方形键/圆圈键控制，响应迅速，操作直观。

---

## 十、总结与反思

### 10.1 成功经验

1. **合理使用 FreeRTOS**：任务划分清晰，优先级设计合理，保证了系统实时性。
2. **平滑过渡算法**：解决了电机减速卡顿问题，显著提升操纵流畅性。
3. **主动刹车机制**：有效解决了惯性滑行问题，提升了定位精度。
4. **系统简化策略**：移除冗余功能（碰撞检测、限位保护、圆圈键锁止），降低维护成本。

### 10.2 圆圈键锁止功能的设计要点（历史版本，已移除）

**注**：此功能已在 2025-11-07 系统重构中移除，圆圈键改为控制开合电机。以下内容仅作为历史记录保留。

在早期版本开发圆圈键锁止功能时，经历了多个版本迭代：

1. **v1.0（5Hz 瞬间切换）**

   - 体验：切换过快，电机噪音大，机械冲击大
   - 缺陷：适合高频场景，不适合持续锁止

2. **v1.1（2Hz + 平滑过渡）**

   - 体验：仍缺乏"停顿"感，持续的正反转显得急躁
   - 缺陷：虽有过渡但无停留，难以给机械完全释放的时间

3. **v1.2（1Hz 全程平滑）**

   - 体验：过于平缓，锁止感不足，实际效果差
   - 缺陷：完全光滑的曲线反而降低了锁止效果

4. **v2.0（三阶段 + 低速）** ← **最终选择**
   - 体验：加速 → 减速 → 停留的循环，既平滑又有明显的"锁止节奏"
   - 优势：
     - 加速/减速阶段提供方向改变的动力
     - 零速停留阶段给机械完全释放的时间
     - 低速(±64)运行降低能耗和噪音
     - 整个周期 2s，频率恰当，易于感知

**关键参数的选择理由**：

- **速度 64**（不是 127）：功率与速度成平方关系，降低到 50% 功率下降 75%
- **阶段时长 500ms**：10ms 轮询下需 50 次迭代，足以保证插值精度
- **零速停留必不可少**：给齿轮、履带等机械完全释放张力的时间

### 10.3 不足与改进方向（2025-11-07 更新）

1. **状态指示缺失**：缺少 LED 或蜂鸣器等状态反馈，调试和使用时不够直观。
2. **开合电机缺少位置反馈**：目前为开环控制，未来可增加编码器或限位开关。
3. **引脚复用风险**：PA2 引脚可能存在复用问题，需要仔细验证硬件连接。

### 10.4 技术启示（2025-11-07 更新）

- **硬件优先原则**：能用硬件解决的问题不用软件解决（如限位保护用机械限位块）。
- **参数需实测调优**：平滑步长、控制周期等均需通过实验确定，而非理论计算。
- **简化优于复杂**：移除碰撞检测、圆圈键锁止等低使用率功能，系统更稳定可靠。
- **用户体验优先**：12%/10ms 的平滑过渡虽微小，但对体验影响巨大。
- **及时重构**：在功能冗余积累到一定程度时，果断简化，避免技术债务。

---

## 十一、未来展望（2025-11-07 更新）

1. **姿态稳定**：引入 IMU（陀螺仪+加速度计），实现斜坡时姿态检测与稳定控制。
2. **半自动路径规划**：在现有差速控制基础上，加入简单视觉识别和路径规划算法，实现半自主导航。
3. **开合电机优化**：
   - 添加位置检测（如编码器或限位开关）
   - 实现自动停止（检测到夹持力度后停止）
   - 支持力度可调（PWM 占空比可调）
4. **控制系统优化**：
   - 优化双摇杆混合算法，支持更复杂的多轴控制
   - 加入重力补偿，提升斜坡上的行驶稳定性
5. **性能监测与诊断**：
   - 添加实时性能监控（如任务执行时间、堆栈使用率）
   - 故障诊断功能（如电机异常检测、通信故障告警）
6. **用户反馈**：
   - 添加 LED 指示灯，显示当前系统状态
   - 添加蜂鸣器，按键操作时发出提示音

---

## 十二、2025年11月7日 - 系统重构与简化

### 12.1 重构背景

在经历了一段时间的实际使用后，发现系统存在以下问题：

1. **硬件变更需求**：机械结构调整，需要新增开合电机以实现机械爪夹持功能
2. **功能冗余**：碰撞检测系统在实际场景中效果不佳，反而增加了代码复杂度
3. **按键资源紧张**：圆圈键被锁止功能占用，无法用于开合电机控制
4. **维护成本高**：限位开关、碰撞检测等多个子系统的调试和维护工作量大

因此决定进行系统简化重构，移除冗余功能，聚焦核心控制逻辑。

### 12.2 硬件变更

#### 12.2.1 引脚重新分配

由于 STM32CubeMX 重新生成代码，部分引脚进行了调整：

| 功能模块     | 原引脚分配       | 新引脚分配         | 驱动器   | 定时器通道    |
| ------------ | ---------------- | ------------------ | -------- | ------------- |
| 底部左侧电机 | PA1/PA2          | PA1/PA2            | L298N_R  | TIM2 CH2/CH3  |
| 底部右侧电机 | PB4/PB5          | PB4/PB5            | L298N_R  | TIM3 CH1/CH2  |
| 升降电机     | PB0/PB1          | PB0/PB1            | L298N_R  | TIM3 CH3/CH4  |
| **开合电机** | **无（新增）**   | **PA2/PA3（新）**  | L298N_L  | TIM2 CH3/CH4  |
| 舵机         | PA8              | PA8                | -        | TIM1 CH1      |
| 碰撞开关     | PA3/PB6（已删除）| **无（已移除）**   | -        | -             |
| 顶部限位开关 | PA9/PA10（已删除）| **无（已移除）**  | -        | -             |

**关键变更**：

- **新增开合电机**：使用 L298N_L 驱动器的 IN3/IN4 接口（PA2/PA3），控制机械爪的开合动作
- **移除碰撞检测**：PA3/PB6 原用于碰撞开关检测，现已废弃
- **移除限位保护**：PA9/PA10 原用于升降限位检测，现已废弃

#### 12.2.2 L298N 驱动器重新分配

系统现在使用两个 L298N 驱动器：

**L298N_R（右侧驱动器）**：

- IN1/IN2 (PA1/PA2) → 底部左侧电机
- IN3/IN4 (PB4/PB5) → 底部右侧电机

**L298N_L（左侧驱动器）**：

- IN1/IN2 (未使用)
- IN3/IN4 (PA2/PA3) → **开合电机（新增）**

注意：PA2 引脚在硬件设计中可能存在复用问题，需确认实际电路连接。

### 12.3 功能移除

为了降低系统复杂度，提升可维护性，进行了以下功能移除：

#### 12.3.1 碰撞检测系统（完全移除）

**移除理由**：

1. **检测效果不佳**：机械开关触发不稳定，经常误判或漏判
2. **纠偏逻辑复杂**：差速纠偏算法需要精细调参，实际效果有限
3. **硬件可靠性低**：碰撞开关易损坏，增加维护成本
4. **使用场景受限**：在实际环境中，人工避障比自动检测更可靠

**代码移除清单**：

- **全局变量**：
  - `volatile float leftMotorScale = 1.0f;`
  - `volatile float rightMotorScale = 1.0f;`
  - `volatile uint8_t collisionDetectionEnabled = 1;`
  
- **任务**：
  - `collisionTask01`（整个任务删除）
  
- **队列**：
  - 无专用队列，不涉及

- **功能代码**：
  - `motorTask01` 中的碰撞缩放系数应用代码
  - L3 键切换碰撞检测使能的代码
  - 差速纠偏逻辑

**影响范围**：

- 底部电机速度不再受碰撞检测影响，纯粹由摇杆和肩键控制
- 简化了 `motorTask01` 的控制流程，提升了响应速度

#### 12.3.2 圆圈键锁止功能（已删除）

**移除理由**：

1. **按键资源紧张**：需要圆圈键用于控制新增的开合电机
2. **使用频率低**：实际使用中，锁止功能使用率极低
3. **功能冗余**：通过摇杆停止输入即可停车，锁止功能非必需

**代码移除清单**：

- **状态机变量**：
  - `lockPhase`（0=加速、1=减速、2=停留）
  - `lockElapsedTime`
  - `currentLockSpeed`

- **功能代码**：
  - `motorTask01` 中的三阶段锁止状态机
  - 圆圈键从 `motorQueue01` 的接收逻辑
  - 线性插值平滑过渡代码

**影响范围**：

- 圆圈键从"锁止模式切换"改为"开合电机反转控制"
- `motorTask01` 逻辑大幅简化，只保留摇杆和肩键控制

#### 12.3.3 限位保护系统（已删除）

**移除理由**：

1. **硬件引脚紧张**：PA9/PA10 需要用于其他功能
2. **机械设计优化**：通过机械限位块实现物理保护，软件保护非必需
3. **维护成本高**：限位开关接线复杂，容易松动

**代码移除清单**：

- **全局变量**：
  - `volatile uint8_t topLimitPressed = 0;`
  - `volatile uint8_t bottomLimitPressed = 0;`（如有）

- **功能代码**：
  - `motorTask02` 中的限位开关检测代码
  - 限位触发时的电机停止逻辑

**影响范围**：

- 升降电机不再有软件限位保护，需依赖机械限位块或人工控制

### 12.4 新增功能

#### 12.4.1 开合电机控制

**硬件配置**：

- **引脚**：PA2/PA3（TIM2 CH3/CH4）
- **驱动器**：L298N_L IN3/IN4
- **PWM频率**：1kHz
- **控制函数**：`Motor_SetSpeedGrip(int16_t speed)`

**控制逻辑**：

```c
// 正转（打开机械爪）
if (speed > 0) {
    IN3 = PWM;
    IN4 = 0;
}
// 反转（关闭机械爪）
else if (speed < 0) {
    IN3 = 0;
    IN4 = PWM;
}
// 锁死（保持当前位置）
else {
    IN3 = HIGH;
    IN4 = HIGH;
}
```

**按键映射**：

- **方形键**：开合电机正转（速度 +127，打开机械爪）
- **圆圈键**：开合电机反转（速度 -127，关闭机械爪）
- **无按键**：电机锁死（速度 0，保持位置）

**新增代码**：

1. **tim.c**：添加 `Motor_SetSpeedGrip()` 函数（约40行）
2. **tim.h**：添加函数声明
3. **freertos.c**：
   - 新增 `motorQueue03`（队列长度5，元素大小2字节）
   - 新增 `motorTask03`（任务优先级 osPriorityNormal）
   - `ps2Task` 中添加方形键和圆圈键的队列发送逻辑

**实现细节**：

- 使用与其他电机相同的控制逻辑（正转/反转/锁死）
- 最大速度限制为 ±127
- 电机停止时采用主动刹车模式（IN3=IN4=HIGH），防止机械爪自动松开

#### 12.4.2 消息队列重新分配

为了适应新的控制需求，重新设计了消息队列分配方案：

| 队列名称      | 数据源  | 数据目标     | 元素大小 | 队列长度 | 内容                                   |
| ------------- | ------- | ------------ | -------- | -------- | -------------------------------------- |
| motorQueue01  | ps2Task | motorTask01  | 12字节   | 5        | 左摇杆 + 右摇杆 + 肩键（L1/L2/R1/R2）  |
| motorQueue02  | ps2Task | motorTask02  | 2字节    | 5        | 三角形键 + X键                         |
| motorQueue03  | ps2Task | motorTask03  | 2字节    | 5        | **方形键 + 圆圈键（新增）**            |
| servoQueue    | ps2Task | servoTask    | 2字节    | 5        | UP键 + DOWN键                          |

**变更说明**：

- **motorQueue01**：不再接收圆圈键数据
- **motorQueue03**：新增队列，专门接收方形键和圆圈键数据
- **ps2Task**：现在向 4 个队列分发数据（原 3 个）

### 12.5 代码重构

#### 12.5.1 `ps2Task` 重构

**重构目标**：

- 移除圆圈键锁止功能的相关代码
- 新增 motorQueue03 的数据发送逻辑
- 简化按键处理流程

**重构前后对比**：

| 功能模块       | 重构前                                   | 重构后                           |
| -------------- | ---------------------------------------- | -------------------------------- |
| 队列数量       | 3（motorQueue01/02, servoQueue）         | 4（新增 motorQueue03）           |
| 圆圈键功能     | 触发底部电机锁止模式（三阶段状态机）     | 触发开合电机反转                 |
| L3 键功能      | 切换碰撞检测使能/禁用                    | **已移除**                       |
| 数据包大小     | motorQueue01=12字节，其他=2字节          | 不变                             |

**关键代码片段**：

```c
// 重构后：圆圈键和方形键发送到 motorQueue03
uint16_t gripData = 0;
if (PS2_KEY_SQUARE) gripData |= 0x01;  // 方形键：开合电机正转
if (PS2_KEY_CIRCLE) gripData |= 0x02;  // 圆圈键：开合电机反转
osMessageQueuePut(motorQueue03Handle, &gripData, 0, 0);
```

#### 12.5.2 `motorTask01` 重构

**重构目标**：

- 移除圆圈键锁止功能（三阶段状态机）
- 移除碰撞检测缩放系数应用
- 简化控制流程，只保留摇杆+肩键控制

**移除代码量**：约 150 行

**重构前后对比**：

| 功能模块         | 重构前                                             | 重构后                     |
| ---------------- | -------------------------------------------------- | -------------------------- |
| 圆圈键锁止       | 三阶段状态机（加速→减速→停留，2s周期）             | **已删除**                 |
| 碰撞检测缩放     | 应用 leftMotorScale/rightMotorScale 全局变量       | **已删除**                 |
| 控制逻辑         | 摇杆 + 肩键 + 圆圈键锁止 + 碰撞纠偏                 | 纯粹摇杆 + 肩键            |
| 代码复杂度       | 高（多分支、状态机、线性插值）                     | 低（线性流程）             |

**简化效果**：

- 代码行数减少约 40%
- 控制响应速度提升（减少状态判断）
- 易于理解和维护

#### 12.5.3 `motorTask02` 重构

**重构目标**：

- 移除顶部限位开关检测逻辑
- 纯粹按键控制，无硬件保护

**移除代码量**：约 20 行

**重构前后对比**：

| 功能模块       | 重构前                                   | 重构后                     |
| -------------- | ---------------------------------------- | -------------------------- |
| 限位保护       | 检测 topLimitPressed 变量，触发时停止    | **已删除**                 |
| 控制逻辑       | 三角形/X键 + 限位保护                    | 纯粹三角形/X键控制         |

#### 12.5.4 `motorTask03` 新增

**功能**：控制开合电机（方形键/圆圈键）

**代码结构**：

```c
void StartMotorTask03(void *argument)
{
    // 启动TIM2 PWM通道3和4（开合电机）
    HAL_TIM_PWM_Start(&htim2, TIM_CHANNEL_3);
    HAL_TIM_PWM_Start(&htim2, TIM_CHANNEL_4);

    uint16_t buttonData = 0;
    int16_t motorSpeed = 0;
    const int16_t MAX_SPEED = 127;

    for (;;) {
        if (osMessageQueueGet(motorQueue03Handle, &buttonData, NULL, 0) == osOK) {
            uint8_t square_pressed = (buttonData & 0x01) ? 1 : 0;
            uint8_t circle_pressed = (buttonData & 0x02) ? 1 : 0;

            if (square_pressed && !circle_pressed) {
                motorSpeed = MAX_SPEED;   // 方形键：打开
            } else if (circle_pressed && !square_pressed) {
                motorSpeed = -MAX_SPEED;  // 圆圈键：关闭
            } else {
                motorSpeed = 0;           // 两键同时按下或无按键：锁死
            }
        }
        Motor_SetSpeedGrip(motorSpeed);
        osDelay(10);
    }
}
```

**设计特点**：

- 与 `motorTask02` 结构相似，保持代码风格一致
- 10ms 控制周期，与其他电机任务相同
- 使用主动刹车模式，防止机械爪自动松开

### 12.6 系统优化效果

#### 12.6.1 代码规模对比

| 指标             | 重构前      | 重构后      | 变化       |
| ---------------- | ----------- | ----------- | ---------- |
| 总代码行数       | ~950 行     | ~860 行     | **-90 行** |
| freertos.c       | ~880 行     | ~810 行     | **-70 行** |
| tim.c            | ~470 行     | ~520 行     | **+50 行** |
| 任务数量         | 5           | 5           | 不变       |
| 队列数量         | 3           | 4           | **+1**     |
| 全局变量数量     | 5           | 0           | **-5**     |

#### 12.6.2 功能对比

| 功能模块         | 重构前                     | 重构后                     |
| ---------------- | -------------------------- | -------------------------- |
| 底部电机控制     | 摇杆+肩键+圆圈键锁止       | 摇杆+肩键                  |
| 升降电机控制     | 三角形/X键 + 限位保护      | 三角形/X键                 |
| **开合电机控制** | **无**                     | **方形键/圆圈键（新增）**  |
| 舵机控制         | UP/DOWN键                  | UP/DOWN键                  |
| 碰撞检测         | 差速纠偏                   | **已移除**                 |
| 限位保护         | 软件检测                   | **已移除**                 |

#### 12.6.3 资源占用对比

| 资源类型   | 重构前      | 重构后      | 变化       |
| ---------- | ----------- | ----------- | ---------- |
| RAM 使用   | 6.8 KB      | 6.5 KB      | **-0.3 KB** |
| 任务栈总和 | 2.5 KB      | 2.5 KB      | 不变       |
| 队列内存   | 96 字节     | 106 字节    | **+10 字节** |

### 12.7 重构总结

#### 12.7.1 设计原则

本次重构遵循以下设计原则：

1. **最小化复杂度**：移除不必要的功能，聚焦核心控制
2. **硬件与软件分离**：机械保护由硬件实现，软件不冗余
3. **功能单一化**：每个任务只负责一个执行器，职责清晰
4. **按键资源优化**：每个按键只对应一个明确的功能，避免复用冲突

#### 12.7.2 经验总结

**成功经验**：

1. **及时简化系统**：在功能冗余积累到一定程度时，果断重构，避免技术债务
2. **硬件优先原则**：能用硬件解决的问题不用软件解决（如限位保护）
3. **功能评估**：定期评估各功能的实际使用率，删除低价值功能（如锁止模式）
4. **代码风格统一**：新增的 `motorTask03` 与 `motorTask02` 结构相似，降低学习成本

**问题与改进**：

1. **引脚复用风险**：PA2 引脚可能存在复用冲突，需要仔细检查硬件连接
2. **缺少硬件保护**：移除限位保护后，需要确保机械限位块可靠
3. **文档更新滞后**：引脚变更后需要及时更新硬件文档和注释

#### 12.7.3 后续优化方向

1. **引脚冲突解决**：
   - 检查 PA2 是否真的存在复用问题
   - 如有冲突，需要重新分配开合电机或底部电机的引脚

2. **开合电机优化**：
   - 添加位置检测（如编码器或限位开关）
   - 实现自动停止（检测到夹持力度后停止）

3. **控制精度提升**：
   - 开合电机可能需要更精细的速度控制（而非仅 ±127）
   - 可以添加 PWM 占空比可调功能

4. **用户体验优化**：
   - 添加 LED 指示灯，显示当前电机状态
   - 添加蜂鸣器，按键操作时发出提示音

---

## 十三、未来展望（更新）
