# PS2 手柄控制方案（全新版本）

## 📋 控制映射总览

### 🎮 底部电机（左右轮）- 双摇杆混合控制

**优先级：摇杆 > 肩键**

#### 摇杆模式（主控制）

- **左摇杆（0.5 权重）** + **右摇杆（0.5 权重）**
- 最终速度 = 左摇杆结果 × 0.5 + 右摇杆结果 × 0.5
- 摇杆 Y 轴：前后控制
- 摇杆 X 轴：左右转向
- 算法：差速转向（leftSpeed = Y - X, rightSpeed = Y + X）后加权混合

#### 肩键辅助模式（仅当摇杆无输出时生效）

- **L1**：左轮反转（速度 -100）
- **L2**：左轮正转（速度 +100）
- **R1**：右轮反转（速度 -100）
- **R2**：右轮正转（速度 +100）

**判断逻辑**：左右摇杆都在死区（±10）内时，才响应肩键

---

### 🔄 舵机 - 方向键左侧控制

- **方向键上**：舵机正转（角度增加，2°/10ms）
- **方向键下**：舵机反转（角度减少，2°/10ms）
- 角度范围：0° ~ 180°
- 转动速度：200°/s

---

### ⚙️ 顶部电机 - 方向键右侧控制

- **三角形键（△）**：正转最大速度（+127）
- **X 键**：反转最大速度（-127）
- 同时按下或无按键：电机锁死（0）

---

## 🎯 控制特性

### 双摇杆混合算法优势

1. **灵活性强**：可以单手左摇杆控制，也可双手协同操作
2. **精确控制**：两个摇杆各 50%权重，平滑混合
3. **不冲突**：肩键只在摇杆无输出时生效，避免误操作

### 安全机制

1. **死区处理**：摇杆中心 ±10 范围视为 0，避免抖动
2. **动态归一化**：防止速度溢出（自动限幅到 ±127）
3. **电机锁死**：速度为 0 时主动刹车（IN1=IN2=HIGH）
4. **PS2 模式检测**：仅在模拟模式(0x79/0x73)响应，数字模式锁死电机

### 碰撞避障集成

- 右侧碰撞 → 左轮减速 40% → 左转避障
- 左侧碰撞 → 右轮减速 40% → 右转避障
- 平滑过渡：50ms 内完成加减速

---

## 🔧 数据流架构

```
PS2手柄
   │
   ├─ 左摇杆 ──────┐
   ├─ 右摇杆 ──────┼──→ motorQueue01 (12字节) → motorTask01 → 底部电机
   ├─ L1/L2/R1/R2 ─┘
   │
   ├─ 方向键上/下 ───→ servoQueue (2字节) → servoTask → 舵机
   │
   └─ 三角形/X键 ────→ motorQueue02 (2字节) → motorTask02 → 顶部电机
```

### motorQueue01 数据包格式（12 字节）

```
[0-3]   uint32_t: 左摇杆 (高16位=Y, 低16位=X)
[4-7]   uint32_t: 右摇杆 (高16位=Y, 低16位=X)
[8-11]  uint32_t: 肩键 (bit0=L1, bit1=L2, bit2=R1, bit3=R2)
```

---

## 📊 控制示例

### 场景 1：双摇杆前进

- 左摇杆：Y=100, X=0 → 左轮=100, 右轮=100
- 右摇杆：Y=100, X=0 → 左轮=100, 右轮=100
- **混合结果**：左轮=100, 右轮=100（直线前进）

### 场景 2：左摇杆前进 + 右摇杆右转

- 左摇杆：Y=100, X=0 → L_left=100, L_right=100
- 右摇杆：Y=0, X=50 → R_left=-50, R_right=50
- **混合结果**：
  - 左轮 = (100 × 0.5) + (-50 × 0.5) = 25
  - 右轮 = (100 × 0.5) + (50 × 0.5) = 75
  - 结果：前进同时右转

### 场景 3：摇杆静止 + L1 按下

- 左摇杆：Y=0, X=0（死区内）
- 右摇杆：Y=0, X=0（死区内）
- L1 按下
- **结果**：左轮=-100（反转），右轮=0（原地左转）

---

## 🛠️ 硬件连接

| 设备     | STM32 引脚 | TIM 通道     | 功能     |
| -------- | ---------- | ------------ | -------- |
| 左电机   | PA1/PA2    | TIM2 CH2/CH3 | 底部左轮 |
| 右电机   | PB4/PB5    | TIM3 CH1/CH2 | 底部右轮 |
| 顶部电机 | PB0/PB1    | TIM3 CH3/CH4 | 上部机构 |
| 舵机     | PA8        | TIM1 CH1     | 云台转向 |

PWM 频率：

- 电机：1kHz
- 舵机：50Hz

---

## ⚡ 性能参数

- **控制频率**：50Hz（PS2 采集 20ms 周期）
- **响应延迟**：< 30ms（采集 → 计算 → 输出）
- **速度分辨率**：±127 级（8 位精度）
- **舵机精度**：1°（0-180° 范围）
- **电机启动时间**：< 50ms（从 0 到最大速度）

---

## 📝 使用建议

1. **上电顺序**：先开发板，后 PS2 接收器，最后按手柄 MODE 键切换到模拟模式
2. **测试顺序**：先测舵机 → 再测单摇杆 → 最后测双摇杆混合
3. **调试技巧**：如电机不响应，检查 PS2 是否在模拟模式（手柄红灯亮）
4. **安全事项**：测试时小车架空，避免失控

---

_最后更新：2025 年 10 月 22 日_
