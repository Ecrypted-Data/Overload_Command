# 舵机控制任务使用说明

## 功能概述

servoTask 任务通过 PS2 手柄的 R1 和 R2 按键控制舵机持续转动。**按住按键时舵机转动，松开按键时立即停止在当前角度**。

## 控制逻辑

```
PS2 手柄              队列              servoTask              舵机
   │                  │                    │                   │
   │   R1/R2 按键     │                    │                   │
   ├──────────────────►  servoQueue        │                   │
   │   (buttonData)   │                    │                   │
   │                  ├────────────────────► 读取按键状态      │
   │                  │                    │                   │
   │   按住 R1        │                    │  角度 -= 2°       │
   │   ─────────────────────────────────────►  (向 0° 转动)    │
   │                  │                    │                   │
   │   按住 R2        │                    │  角度 += 2°       │
   │   ─────────────────────────────────────►  (向 180° 转动)  │
   │                  │                    │                   │
   │   R1+R2 同时按   │                    │  停止转动         │
   │   ─────────────────────────────────────►  (冲突保护)      │
   │                  │                    │                   │
   │   松开按键       │                    │  停止转动         │
   │   ─────────────────────────────────────►  (保持当前角度)  │
   │                  │                    │                   │
   │                  │                    ├───────────────────► PWM 输出
   │                  │                    │   Servo_SetAngle() │ 转动/停止
   │                  │                    │                   │
```

## 按键映射

| 按键                | 功能   | 动作             | 说明                             |
| ------------------- | ------ | ---------------- | -------------------------------- |
| R1（前部右侧 1 号） | 向左转 | 持续向 0° 转动   | 按住时持续减小角度，松开立即停止 |
| R2（前部右侧 2 号） | 向右转 | 持续向 180° 转动 | 按住时持续增大角度，松开立即停止 |
| R1 + R2 同时按下    | 停止   | 停止转动         | 按键冲突保护，舵机保持当前角度   |
| 无按键              | 停止   | 保持当前角度     | 舵机立即停止在当前位置           |

## 运行特性

### 1. 持续转动模式

- 舵机**不会自动转到固定位置**
- 按住按键期间持续转动
- 松开按键立即停止
- 可以停在 0° - 180° 之间的任意角度

### 2. 响应行为

```c
// 按住 R1
按键按下 → 每 10ms 角度 -2° → 到达 0° 停止 → 松开后保持 0°

// 按住 R2
按键按下 → 每 10ms 角度 +2° → 到达 180° 停止 → 松开后保持 180°

// R1 和 R2 同时按下（按键冲突）
同时按下 → 舵机停止转动 → 保持当前角度 → 松开后继续可控

// 中途松开（例如在 74° 时）
按住 R1 → 90° → 88° → 86° → ... → 74° → 松开 → **立即停在 74°**
```

### 3. 角度限制

```c
// 自动限制在有效范围内
if (currentAngle > 1) {
    currentAngle -= 2;  // 每次减 2°，不会小于 0°
} else {
    currentAngle = 0;   // 接近边界时直接到 0°
}

if (currentAngle < 179) {
    currentAngle += 2;  // 每次加 2°，不会大于 180°
} else {
    currentAngle = 180; // 接近边界时直接到 180°
}
```

```
PS2 手柄              队列              servoTask              舵机
   │                  │                    │                   │
   │   R1/R2 按键     │                    │                   │
   ├──────────────────►  servoQueue        │                   │
   │   (buttonData)   │                    │                   │
   │                  ├────────────────────► 读取按键状态      │
   │                  │                    │                   │
   │                  │                    │  判断目标角度     │
   │                  │                    │  (0° 或 180°)     │
   │                  │                    │                   │
   │                  │                    │  逐渐调整角度     │
   │                  │                    │  (每次 ±1°)       │
   │                  │                    │                   │
   │                  │                    ├───────────────────► PWM 输出
   │                  │                    │   Servo_SetAngle() │ 转动
   │                  │                    │                   │
```

## 按键映射

| 按键                | 功能   | 目标角度 | 说明                    |
| ------------------- | ------ | -------- | ----------------------- |
| R1（前部右侧 1 号） | 向左转 | 0°       | 按住时舵机逐渐转至 0°   |
| R2（前部右侧 2 号） | 向右转 | 180°     | 按住时舵机逐渐转至 180° |
| 无按键              | 保持   | 当前角度 | 松开按键后保持当前位置  |

## 运行特性

### 1. 平滑转动

- 舵机不会立即跳转到目标角度
- 每 10ms 调整 1°
- 转动速度：100°/秒
- 从 0° 到 180° 需要约 1.8 秒

### 2. 响应行为

```c
// 按住 R1
按键按下 → 目标角度设为 0° → 每 10ms 减少 1° → 到达 0° 停止

// 按住 R2
按键按下 → 目标角度设为 180° → 每 10ms 增加 1° → 到达 180° 停止

// 松开按键
松开 → 保持当前目标角度 → 舵机停在当前位置
```

### 3. 中途切换

```c
// 场景：舵机正在从 90° 向 0° 转动
当前角度 85° → 按下 R2 → 目标改为 180° → 立即开始向 180° 转动
```

## 代码实现要点

### 初始化

```c
void StartServoTask(void *argument)
{
    extern TIM_HandleTypeDef htim1;
    uint16_t buttonData = 0;
    uint16_t currentAngle = 0;   // 初始位置：0°

    // 启动 PWM
    HAL_TIM_PWM_Start(&htim1, TIM_CHANNEL_1);

    // 设置初始角度
    Servo_SetAngle(currentAngle);
    osDelay(100);

    // ... 主循环
}
```

### 主循环逻辑（新版本）

```c
for (;;) {
    // 1. 非阻塞读取按键状态
    if (osMessageQueueGet(servoQueueHandle, &buttonData, NULL, 0) == osOK) {
        // 检测按键冲突：R1 和 R2 同时按下时停止转动
        if ((buttonData & 0x01) && (buttonData & 0x02)) {
            // 两个按键同时按下，舵机停止（不改变角度）
        }
        // R1 按下：向 0° 方向转动
        else if (buttonData & 0x01) {
            if (currentAngle > 1) {
                currentAngle -= 2;  // 每次减 2°
            } else {
                currentAngle = 0;   // 接近边界时直接到 0°
            }
        }
        // R2 按下：向 180° 方向转动
        else if (buttonData & 0x02) {
            if (currentAngle < 179) {
                currentAngle += 2;  // 每次加 2°
            } else {
                currentAngle = 180; // 接近边界时直接到 180°
            }
        }
        // 没有按键按下：不改变角度（停止转动）
    }

    // 2. 更新舵机位置
    Servo_SetAngle(currentAngle);

    // 3. 延时 10ms
    osDelay(10);
}
```

### 关键特性

- **即时响应**：松开按键后，下一次循环（10ms 内）就会停止转动
- **精确控制**：可以通过按键时长精确控制舵机角度
- **平滑运动**：每次改变 2°，转动快速但依然平滑
- **边界保护**：自动限制在 0° - 180° 范围内
- **冲突保护**：R1 和 R2 同时按下时舵机停止，防止误操作

## 参数调整

### 调整转动速度

修改增量和延时可以改变转动速度：

```c
// 当前：200°/秒（每次 2°，延时 10ms）
currentAngle += 2;  // 每次 2°
osDelay(10);        // 延时 10ms

// 更快：400°/秒（每次 4°，延时 10ms）
currentAngle += 4;  // 每次 4°
osDelay(10);        // 延时 10ms

// 更慢：100°/秒（每次 1°，延时 10ms）
currentAngle += 1;  // 每次 1°
osDelay(10);        // 延时 10ms
```

### 调整角度范围

如果需要限制舵机转动范围：

```c
// 限制在 30° 到 150° 之间
if (buttonData & 0x01) {
    if (currentAngle > 31) {   // 最小角度 30°（考虑步进为2°）
        currentAngle -= 2;
    } else {
        currentAngle = 30;
    }
}
else if (buttonData & 0x02) {
    if (currentAngle < 149) {  // 最大角度 150°（考虑步进为2°）
        currentAngle += 2;
    } else {
        currentAngle = 150;
    }
}
```

## 常见问题

### 1. 舵机抖动

**原因**：电源不稳定或电流不足  
**解决**：

- 使用独立的 5V 电源供电
- 在电源线上加入 100μF-1000μF 电容滤波
- 确保 GND 共地

### 2. 舵机无响应

**原因**：PWM 未启动或信号线连接错误  
**解决**：

- 检查 `HAL_TIM_PWM_Start()` 是否被调用
- 确认 PA8 连接到舵机信号线
- 使用示波器检查 PWM 信号

### 3. 舵机转动不到位

**原因**：PWM 脉宽范围不匹配  
**解决**：

- 不同舵机的脉宽范围可能不同
- 调整 `Servo_SetAngle()` 函数中的计算公式
- 标准：0.5ms-2.5ms，有些舵机是 1ms-2ms

### 4. 按键无响应

**原因**：队列数据未更新或 PS2 连接问题  
**解决**：

- 检查 PS2 手柄连接状态（绿灯常亮）
- 确认 ps2Task 正在运行
- 检查队列是否正确创建

## 测试步骤

1. **上电初始化**

   - 舵机应移动到 **0° 位置**（初始位置）
   - 等待 100ms 稳定

2. **测试 R2 按键（向 180° 转动）**

   - 按住 R2
   - 观察舵机持续向 180° 方向转动
   - 松开 R2
   - 舵机**立即停止**在当前位置（例如 90°）

3. **测试 R1 按键（向 0° 转动）**

   - 按住 R1
   - 观察舵机持续向 0° 方向转动
   - 松开 R1
   - 舵机**立即停止**在当前位置（例如 45°）

4. **测试按键冲突保护**

   - 从任意位置开始
   - 同时按下 R1 和 R2
   - 舵机应**停止转动**，保持当前角度不变
   - 松开其中一个按键
   - 舵机应按另一个按键方向开始转动

5. **测试精确控制**

   - 从 0° 位置开始
   - 短暂按下 R2（约 0.25 秒）
   - 舵机应转动约 50°，停在约 50° 位置
   - 短暂按下 R1（约 0.15 秒）
   - 舵机应转动约 30°，停在约 20° 位置

   **注意**：由于每次步进 2°，实际角度为偶数或奇数取决于起始位置

6. **测试边界保护**
   - 持续按住 R1 直到舵机停止（应停在 0°）
   - 继续按住 R1，舵机应保持在 0° 不动
   - 持续按住 R2 直到舵机停止（应停在 180°）
   - 继续按住 R2，舵机应保持在 180° 不动

## 扩展应用

### 1. 多速度控制

可以根据按键组合实现多档速度：

```c
static uint8_t speed = 1;  // 默认速度

// 根据其他按键调整速度（例如使用 L1）
if (l1_pressed) {
    speed = 2;  // 快速模式
} else {
    speed = 1;  // 正常模式
}

// 应用速度
if (buttonData & 0x01) {
    if (currentAngle > 0) {
        currentAngle -= speed;  // 使用可变速度
        if (currentAngle > 180) currentAngle = 0;  // 防止溢出
    }
}
```

### 2. 微调模式

使用方向键实现精确微调（每次移动 1°）：

```c
// 使用方向键精确控制
if (buttonData & 0x10) {      // 上键
    if (currentAngle < 180) currentAngle += 1;
}
else if (buttonData & 0x40) {  // 下键
    if (currentAngle > 0) currentAngle -= 1;
}
```

### 3. 位置记忆

记录多个预设位置：

```c
static uint8_t presetPos[4] = {0, 60, 120, 180};
static uint8_t currentPreset = 1;  // 当前预设（90°）

// 使用 START 键切换预设
if (start_pressed) {
    currentPreset = (currentPreset + 1) % 4;
}

// 按下 SELECT 键跳转到预设位置
if (select_pressed) {
    // 平滑移动到预设位置
    targetAngle = presetPos[currentPreset];
}
```

### 4. 连续摇杆控制（如果使用模拟模式）

```c
// 使用右摇杆 X 轴实现连续角度控制
uint8_t joystickX = ps2Data.rightX;

// 死区处理（中心位置 128±10 不响应）
if (joystickX < 118) {
    // 向左转（0°方向）
    if (currentAngle > 0) currentAngle -= 1;
}
else if (joystickX > 138) {
    // 向右转（180°方向）
    if (currentAngle < 180) currentAngle += 1;
}
// 死区内不动作
```

## 优势总结

### 性能特性

- **转速**：200°/秒（每 10ms 改变 2°）
- **响应时间**：10ms（松开按键到停止）
- **任务负载**：合理（10ms 延时，适合多任务环境）
- **平滑度**：良好（步进 2°，人眼感觉平滑）
- **完整行程时间**：0.9 秒（从 0° 到 180°）

### 与目标位置模式对比

| 特性     | 持续转动模式（当前） | 目标位置模式（旧版） |
| -------- | -------------------- | -------------------- |
| 精确控制 | ✅ 可停在任意角度    | ❌ 只能停在固定位置  |
| 响应速度 | ✅ 松开立即停止      | ❌ 继续转到目标位置  |
| 操作直觉 | ✅ 按多久转多少      | ⚠️ 需要提前预判      |
| 灵活性   | ✅ 自由度高          | ⚠️ 受限于预设位置    |
| 适用场景 | 需要精确控制角度     | 只需要几个固定位置   |

### 适用场景

- ✅ 云台控制（摄像头上下左右）
- ✅ 机械臂关节控制
- ✅ 阀门开度控制
- ✅ 需要精确角度定位的应用
- ✅ 遥控车转向控制

### 控制技巧

1. **短按**：微调角度（每次约 1-5°）
2. **长按**：大幅度转动
3. **点按**：快速调整到附近位置
4. **配合其他按键**：实现多功能控制
