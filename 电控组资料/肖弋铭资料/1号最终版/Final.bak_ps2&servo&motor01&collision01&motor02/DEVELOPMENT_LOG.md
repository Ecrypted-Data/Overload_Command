# 一号小车开发日志

**最后编辑时间**: 2025 年 10 月 22 日
**硬件平台**: STM32F103C8T6 （ ST-Link V2 )
**开发工具**: STM32CubeMX + VSCode + EIDE + OpenOCD + Cortex-Debug ( + Serial Monitor )

---

## 一、项目背景与目标

本项目旨在实现一号参赛小车的电控，具备以下功能：
1. **远程控制**：通过双灯版 PS2 控制小车进行一系列任务。
2. **后舱开合**：通过 L1/L2 控制舵机角度来控制舱门开合。
3. **履带运动**：通过 PS2 手柄左右摇杆独立控制左右电机，带动履带运动。
4. **路线纠偏**：通过两侧微动开关检测底部实体状态并自动调整行驶方向。
5. **顶部集球装置位移**：通过 R1/R2 控制顶部装置升降，并附带限位功能。

设计目标不仅是实现功能，还要保证 **实时性、稳定性和可扩展性**。因此在开发过程中，重点关注以下问题：
- 输入采样与电机控制的实时性
- 硬件接口的稳定性（SPI、PWM、GPIO）
- 系统任务调度与资源分配
- 操纵手控制（响应延迟、控制平滑性）

---

## 二、技术选型与设计取舍

### 2.1 操作系统：FreeRTOS vs 裸机

- **裸机轮询**：实现简单，但难以保证多任务实时性。
- **FreeRTOS**：支持任务优先级、队列通信，能更好地协调输入采样、电机驱动和避障逻辑。

**选择理由**： 由于小车需要同时处理 **50Hz 的手柄输入**、**100Hz 的电机控制** 和 **高优先级的碰撞检测**，裸机实现会导致任务间抢占困难。FreeRTOS 的调度机制能保证关键任务优先执行，提升系统稳定性。

### 2.2 PS2 连接方式：软件 GPIO vs 硬件 SPI

| 方案   | 优点            | 缺点             | 适用性分析                       |
| ---- | ------------- | -------------- | --------------------------- |
| GPIO | 已有现成驱动文件，配置灵活 | CPU 开销较大       | 适合快速开发，简易连接，不适合 CPU 资源紧张的情形 |
| SPI  | 性能消耗小         | 现有教程不适配双灯版 PS2 | 适合单片机多任务情形                  |


**选择理由**：小车通过 FreeRTOS 处理四到五个任务，且 PS2 轮询频率较高，对 CPU 需求较大，选择 SPI 节省性能。

---

## 三、PS2 通信模块

### 3.1 设计目标

- 稳定读取手柄数据。
- 支持摇杆与按键的实时解析，数据发送到队列。

### 3.2 技术难点与解决方案

- **问题 1：SPI 模式错误**
    - 初始配置按照 PPT 教程进行，导致连接器绿灯慢闪（通信不稳定）。
    - 查阅资料后确认双灯版 PS2 需 **CPHA = 2 Edge**  。
    - 修改后通信稳定，连接控制正常。
- **问题 2：数据解析**
    - 摇杆范围为 0–255，不便于电机控制。
    - 解决方案：转换为 -128 ~ +127，便于差速计算。

### 3.3 FreeRTOS 任务设计

- **优先级**：AboveNormal，保证输入响应及时，同时低于纠偏任务的优先级。
- **数据流向**：
    - 摇杆数据 → motorQueue01
    - L1/L2 → servoQueue
    - R1/R2 → motorQueue02

---

## 四、舵机控制系统

### 4.1 设计目标

- 通过 L1/L2 按键实现舵机角度调节。
- 控制逻辑需支持连续转动与冲突保护。

### 4.2 技术实现

- 使用 TIM1 CH1 输出 50Hz PWM。
- 角度映射：0°→0.5ms，180°→2.5ms。

### 4.3 难点与优化

- **问题：按键单次触发导致控制不连续**
    - 改进：按住时持续转动，每 10ms 调整 2°。
- **问题：L1/L2 同时按下逻辑冲突**
    - 解决：检测到同时按下时停止动作。

---

## 五、双电机驱动系统

### 5.1 设计目标

- 左右电机独立控制，实现差速转向。
- 停止时需支持“主动刹车”，避免惯性滑行。

### 5.2 技术实现

- 驱动芯片：L298N，H 桥控制。
- PWM 频率：1kHz，避免电机啸叫。
- **主动刹车逻辑**：
    - speed=0 → IN1=HIGH, IN2=HIGH，形成短路制动。

### 5.3 优化措施

- 增加摇杆死区（±10），避免机械抖动导致电机微动。

---

## 六、实体碰撞检测与纠偏

### 6.1 设计目标

- 底部一侧无实体后另一侧电机自动减速来转向，避免掉落。
- 高优先级、快速相应的同时保证去抖。

### 6.2 技术难点与解决方案

- **问题 1：中断抖动严重**
    - 初始方案：GPIO EXTI 中断，结果抖动频繁。
    - 改进：改为 10ms 轮询 + 50ms 防抖，更稳定。
- **问题 2：逻辑反转**
    - 微动开关为 NO 型，导致逻辑与预期相反。
    - 解决：确认硬件特性后修正判断条件。
- **问题 3：减速卡顿**
    - 速度突变导致机械冲击。
    - 解决：引入“目标速度 + 平滑过渡”，每 10ms 调整 12%。

### 6.3 参数调优

- 减速比例：60% → 30% → **40%（最佳）**
- 平滑步长：5% → 20% → **12%（最佳）**

---

## 七、系统集成与调试

- **任务优先级**：碰撞检测最高，PS2 次高，电机与舵机为普通优先级。
- **队列大小**：根据采样周期与任务周期计算，避免数据积压或延迟。
- **实测性能**：
    - PS2 通信延迟：256µs
    - 碰撞响应：<60ms
    - 电机控制频率：100Hz

---

## 八、功能迭代与优化

1. **电机锁死功能**：由自由滑行改为主动刹车，停车响应时间从 ~300ms 降至 <50ms ，同时防止斜坡滑动。
2. **上部电机控制**：新增 motorTask02 ，R1/R2 控制顶部电机，支持正反转。
3. **代码优化**：统一注释风格、规范变量命名。

---

## 九、性能总结

在完成所有功能开发与优化后，对系统的性能进行了量化评估。评估维度包括 **资源占用、实时性、响应速度、控制精度** 等。

### 9.1 系统资源占用

| 资源类型 | 使用量    | 总量    | 占用率   | 说明                                                        |
| ---- | ------ | ----- | ----- | --------------------------------------------------------- |
| RAM  | 6.8 KB | 20 KB | 34.0% | 包含任务栈、FreeRTOS 堆、全局变量                                     |
| 任务数  | 5      | -     | -     | ps2Task、servoTask、motorTask01、motorTask02、collisionTask01 |
| 队列数  | 3      | -     | -     | motorQueue01、motorQueue02、servoQueue                      |

**分析**：

- RAM 占用率约三分之一，主要消耗在任务栈和 FreeRTOS 堆上，合理分配后仍有余量。
- 系统整体资源利用率均衡，没有出现瓶颈。

### 9.2 实时性与响应速度

| 功能模块     | 周期/频率             | 响应时间  | 说明              |
| -------- | ----------------- | ----- | --------------- |
| PS2 数据采样 | 20ms / 50Hz       | <25ms | 保证输入无明显延迟       |
| 电机控制     | 10ms / 100Hz      | <15ms | 足够平滑，避免抖动       |
| 舵机控制     | 10ms / 100Hz      | <20ms | 连续转动，响应及时       |
| 碰撞检测     | 10ms 轮询 + 50ms 防抖 | <60ms | 及时纠偏，防止掉落       |
| 停车响应     | 立刻                | <50ms | 主动刹车模式，显著优于自由滑行 |

**分析**：

- 关键任务均在 100ms 内完成，满足实时性要求。
- 碰撞检测响应时间主要受防抖延迟影响，但 60ms 已足够快。
- 电机锁死功能使停车响应时间缩短至 <50ms，显著提升了控制精度。

### 9.3 控制精度与操纵方便度

- **摇杆死区**：±10，有效避免了机械抖动导致的误触发。
- **电机平滑过渡**：12%/10ms 的调整步长，使减速/加速过程自然，无顿挫感。
- **舵机转速**：200°/s，0°→180° 约 0.9s，满足快速响应需求。
- 自动纠偏：通过差速实现自然转向，无需停车，行驶过程流畅。

---

## 十、总结与反思

### 10.1 成功经验

1. **合理使用 FreeRTOS**：任务划分清晰，优先级设计合理，保证了系统实时性。
2. **平滑过渡算法**：解决了电机减速卡顿问题，显著提升操纵流畅性。    
3. **主动刹车机制**：有效解决了惯性滑行问题，提升了定位精度。
4. **轮询替代中断**：在碰撞检测中，轮询方案比中断更稳定，降低了调试复杂度。

### 10.2 不足与改进方向

1. **避障策略单一**：目前仅支持减速转向，未来可加入后退、停止等更复杂的策略。
2. **状态指示缺失**：缺少 LED 或蜂鸣器等状态反馈，调试和使用时不够直观。

### 10.3 技术启示

- **硬件特性必须确认**：如 NO/NC 开关逻辑，避免因假设错误导致逻辑反转。
- **参数需实测调优**：减速比例、平滑步长等均需通过实验确定，而非理论计算。
- **简单方案往往更可靠**：中断虽先进，但在某些场景下轮询更稳定。
- **用户体验优先**：50ms 的平滑过渡虽微小，但对体验影响巨大。

---

## 十一、未来展望

1. **姿态稳定**：引入 IMU（陀螺仪+加速度计），实现斜坡时姿态检测与稳定控制。
2. **半自动路径规划**：在现有差速控制基础上，加入简单视觉识别和路径规划算法，实现半自主导航。