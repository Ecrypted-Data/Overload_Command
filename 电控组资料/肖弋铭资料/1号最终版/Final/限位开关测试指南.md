# 顶部电机限位开关测试指南

**日期**: 2025年10月25日  
**功能**: 顶部电机上下限位保护  
**硬件**: 直柄三脚行程开关 × 2

---

## 一、硬件连接说明

### 1.1 行程开关接线

| 引脚 | 连接位置 | 说明 |
|------|---------|------|
| **上限位开关** | | |
| COM | GND | 公共端接地 |
| NO/NC | PA9 | 信号端接STM32（内部已上拉） |
| **下限位开关** | | |
| COM | GND | 公共端接地 |
| NO/NC | PA10 | 信号端接STM32（内部已上拉） |

### 1.2 连接方式确认

**当前代码假设接 NO（常开）端**：
- 未按下时：NO断开 → GPIO读取为 `HIGH`（上拉）
- 按下时：NO闭合接地 → GPIO读取为 `LOW`

**如果实际接 NC（常闭）端**，需要修改代码中的判断逻辑（见第三章）。

---

## 二、功能测试步骤

### 2.1 初步测试（确认硬件连接）

1. **上电前检查**
   - 用万用表测试开关状态
   - 确认COM已接地
   - 确认信号线接到正确GPIO

2. **串口调试输出**（可选）
   在 `collisionTask02` 中添加调试代码：
   ```c
   // 在状态变化后添加
   printf("Top: %d, Bottom: %d\n", topLimitPressed, bottomLimitPressed);
   ```

3. **手动触发测试**
   - 手动按下上限位开关 → 观察串口输出
   - 手动按下下限位开关 → 观察串口输出
   - 确认状态变化正确

### 2.2 电机限位测试

1. **测试上限位保护**
   - 手动按住上限位开关
   - 按下PS2手柄的**三角形键**（正转）
   - **预期结果**：电机不转动（被限位保护）
   - 按下PS2手柄的**X键**（反转）
   - **预期结果**：电机正常反转（允许离开限位）

2. **测试下限位保护**
   - 手动按住下限位开关
   - 按下PS2手柄的**X键**（反转）
   - **预期结果**：电机不转动（被限位保护）
   - 按下PS2手柄的**三角形键**（正转）
   - **预期结果**：电机正常正转（允许离开限位）

3. **测试正常运行**
   - 不按任何限位开关
   - 按下PS2手柄的**三角形键**或**X键**
   - **预期结果**：电机正常双向运行

---

## 三、逻辑反转说明

### 3.1 如果接的是 NC（常闭）端

**现象**：限位逻辑反了（应该转的时候不转，不应该转的时候反而能转）

**解决方法**：修改 `collisionTask02` 中的判断逻辑

找到以下代码（约在第975-1015行）：

```c
// 原代码（NO连接）
if (topSwitchState == GPIO_PIN_RESET) {
    topLimitPressed = 1;  // 触发
} else {
    topLimitPressed = 0;  // 未触发
}
```

改为：

```c
// 新代码（NC连接）
if (topSwitchState == GPIO_PIN_SET) {
    topLimitPressed = 1;  // 触发
} else {
    topLimitPressed = 0;  // 未触发
}
```

同样修改下限位的判断：

```c
// 原代码（NO连接）
if (bottomSwitchState == GPIO_PIN_RESET) {
    bottomLimitPressed = 1;
} else {
    bottomLimitPressed = 0;
}
```

改为：

```c
// 新代码（NC连接）
if (bottomSwitchState == GPIO_PIN_SET) {
    bottomLimitPressed = 1;
} else {
    bottomLimitPressed = 0;
}
```

### 3.2 判断标准

| 连接方式 | 未按下状态 | 按下状态 | 触发条件 |
|---------|-----------|---------|---------|
| **NO（常开）** | HIGH | LOW | `== GPIO_PIN_RESET` |
| **NC（常闭）** | LOW | HIGH | `== GPIO_PIN_SET` |

---

## 四、性能参数

| 参数 | 数值 | 说明 |
|------|------|------|
| 轮询周期 | 10ms | 快速响应 |
| 防抖延迟 | 30ms | 避免误触发 |
| 响应时间 | <40ms | 触发到停止的总延迟 |
| 任务优先级 | AboveNormal | 确保及时处理 |

---

## 五、安全注意事项

1. ⚠️ **首次测试时**：手动触发限位开关，不要让电机实际到达限位位置
2. ⚠️ **确认逻辑正确后**：再进行完整行程测试
3. ⚠️ **如果限位失效**：立即断电检查硬件连接
4. ⚠️ **长期使用**：定期检查行程开关的机械状态

---

## 六、故障排查

### 6.1 问题：限位不生效

**可能原因**：
- 硬件连接错误（检查COM、NO/NC）
- GPIO配置错误（检查CubeMX配置）
- 防抖延迟过长（尝试缩短到10ms）

**检查方法**：
- 用万用表测量GPIO电压变化
- 添加串口输出观察状态变化
- 检查 `topLimitPressed` 和 `bottomLimitPressed` 的值

### 6.2 问题：限位反转（该停不停，不该停反停）

**原因**：NO/NC连接方式与代码不匹配

**解决**：参见第三章"逻辑反转说明"

### 6.3 问题：限位抖动（频繁触发）

**原因**：机械抖动或防抖延迟太短

**解决**：
- 增加防抖延迟（改为50ms）
- 检查开关机械状态
- 增加开关固定的稳定性

---

## 七、代码修改记录

### 7.1 新增全局变量（~Line 127-136）
```c
volatile uint8_t topLimitPressed = 0;
volatile uint8_t bottomLimitPressed = 0;
```

### 7.2 collisionTask02 更新（~Line 926-1037）
- 实现限位开关轮询
- 防抖处理
- 状态更新

### 7.3 motorTask02 更新（~Line 1040-1115）
- 添加限位保护逻辑
- 仅在PS2控制时应用限位
- 自动停止电机避免损坏

---

## 八、后续优化建议

1. **状态指示**：添加LED或蜂鸣器指示限位触发
2. **软件限位**：记录电机运行时间，增加软件限位保护
3. **自动归位**：开机时自动寻找下限位作为零点
4. **位置反馈**：如有编码器，可实现精确位置控制

---

**测试完成后请记录**：
- [ ] 上限位开关连接方式：NO / NC
- [ ] 下限位开关连接方式：NO / NC
- [ ] 限位保护功能正常：是 / 否
- [ ] 需要反转逻辑：是 / 否
