# 一号机器人综合设计与开发日志

**最后编辑时间**: 2025 年 10 月 23 日

---

## 一、设计总纲

### 1.1 竞赛情景分析

根据比赛策略，1号机器人需在赛场上扮演多重角色，其主要任务包括：

- **高台抢占与防守**：与对方机器人在中央高台进行对抗，具备较强的挤压与抗挤压能力。
- **弹丸接收**：高效承接从中央高台下落的弹丸。
- **弹丸转运**：安全、稳定地接收来自2号机器人的弹丸。
- **战术干扰**：具备干扰对方机器人行动的能力。

### 1.2 功能需求定义

基于以上情景分析，1号机器人的核心功能需求被定义为：

- **挤压排斥能力**：能够在物理对抗中取得优势。
- **弹丸承接能力**：最大化弹丸的接收效率。
- **弹丸转移能力**：实现与队友机器人的高效对接。
- **弹丸存储能力**：具备大容量的弹丸存储空间。
- **桥梁通行能力**：快速稳定地通过赛场中的桥梁。

---

## 二、硬件系统设计

硬件系统是实现机器人所有功能的基础。本章节将详细阐述各机械模块的设计思路、技术选型与实现过程。

### 2.1 硬件总体架构

为实现上述功能，1号机器人被设计为模块化结构，主要包括：

- **履带底盘模块**：提供强大的抓地力和机动性。
- **主体弹舱模块**：作为弹丸存储的核心单元。
- **排斥铲斗模块**：用于挤压对抗。
- **承接漏斗模块**：用于接收高台下落的弹丸。
- **转移舱门模块**：用于与2号机器人对接。
- **磁吸对接模块**：提升对接过程的稳定性。
- **桥梁纠偏模块**：确保桥梁通行的稳定性。

硬件电路拓扑图如下所示：

![1号机器人 硬件拓扑图.png](1号机器人%20硬件拓扑图.png)

#### 开发日志

- **2025.10.4**：完成1号机器人硬件电路拓扑图的初步绘制。

### 2.2 履带底盘模块

**设计目标**：实现强大的挤压排斥能力和稳定的机动性。

**技术选型与实现**：

- **驱动方案**：为获得最大抓地力，选用橡胶材质履带，并采用两颗 **33GB-520 电机** 独立驱动，搭配 **L298N 驱动板** 进行控制。该方案动力充沛，足以应对高强度的物理对抗。
- **结构设计**：底盘主体采用 PLA 3D 打印件，在保证结构强度的同时，有效控制了成本与重量。为确保通过桥梁时的稳定性，两履带中心面间距设计为 **20cm**。
- **硬件集成**：底盘内部设计了独立的硬件舱，用于收纳主控板、电池、驱动板等电控元件，便于布线与维护。

#### 开发日志

- **2025.10.7**：完成履带底盘模块的基本设计与选材。
- **2025.10.12**：完成履带底盘模块的建模。

### 2.3 主体弹舱模块

**设计目标**：实现大容量的弹丸存储。

**技术选型与实现**：

- **框架材料**：综合考虑成本、重量与强度，选用 **10mm×10mm 的 PLA 打印件** 作为弹仓的整体框架。
- **承接面**：为减轻重量并保证弹丸不会漏出，采用 **孔径为 7mm 的无结尼龙网** 包裹框架。
- **连接方式**：采用束线带及紧固件固定尼龙网与框架，便于安装和更换。
- **尺寸**：为在体积限制内最大化容量，弹仓尺寸设计为 **150mm×150mm×200mm**。

![主题弹仓模块.png](相关图示/主题弹仓模块.png)

#### 开发日志

- **2025.10.7**：完成主体弹舱模块的基本设计与选材。
- **2025.10.12**：完成主体弹舱模块的建模。

### 2.4 排斥铲斗模块

**设计目标**：在挤压对抗中获得优势。

**技术选型与实现**：

- **外形设计**：铲斗设计为 **弧面楔形**，能够在挤压和被挤压时，通过改变接触角度来获得力学优势。
- **材料**：考虑到定制化需求、强度及轻量化，采用 **PLA 3D 打印件** 作为主要材料。

![排斥铲斗模块.png](相关图示/排斥铲斗模块.png)

#### 开发日志

- **2025.10.7**：完成排斥铲斗模块的基本设计与选材。
- **2025.10.13**：完成排斥铲斗模块的建模。

### 2.5 承接漏斗模块

**设计目标**：高效接收从天而降的弹丸，并具备伸缩功能以适应不同赛况。

**技术选型与实现**：

- **伸缩结构**：采用两个 **N20 电机** 结合 **齿轮-齿条结构** 实现漏斗的垂直升降。
- **限位功能**：搭配两个 **直柄碰撞传感器** 作为行程开关，实现升降过程的限位自停，防止机械结构损坏。
- **漏斗设计**：管道顶部设有一个由四根结构杆撑起的 **网状漏斗**，关节处设有扭转弹簧。在收纳状态下，漏斗与管道平行；伸出后，漏斗自动向外张开，形成一个大口径的接收区域，显著增大弹丸的接收面积。

![承接漏斗模块.png](相关图示/承接漏斗模块.png)

#### 开发日志

- **2025.10.7**：完成承接漏斗模块的基本设计与选材。
- **2025.10.13**：完成承接漏斗模块的建模。

### 2.6 转移舱门模块

**设计目标**：与2号机器人高效、稳定地对接，接收其收集的弹丸。

**技术选型与实现**：

- **开合控制**：舱门后方设有一个由 **SG90 舵机** 控制的开合机构。
- **尺寸匹配**：舱门的位置和尺寸经过精心设计，与2号机器人的翻斗弹仓模块相适应，确保转移过程无缝衔接。
- **材料**：采用 **PLA 3D 打印件**，以满足定制化需求。

![转移舱门模块.png](相关图示/转移舱门模块.png)

#### 开发日志

- **2025.10.7**：完成转移舱门模块的基本设计与选材。
- **2025.10.14**：完成转移舱门模块的建模。

### 2.7 磁吸对接模块

**设计目标**：提升与2号机器人对接过程的稳定性与抗干扰能力。

**技术选型与实现**：

- **初始方案**：设计一个L型的活动件，利用磁铁吸附形成侧向互锁结构。
- **迭代优化**：由于设计空间有限，原方案过于复杂。现简化为 **凹凸圆锥形** 结构，在圆锥顶面设置磁铁圆片。靠近时，两个圆锥结构能够自动对正并吸附，实现快速、稳定的对接。

![磁吸对接模块.png](相关图示/磁吸对接模块.png)

#### 开发日志

- **2025.10.7**：完成磁吸对接模块的初始设计。
- **2025.10.13**：基于空间限制，对模块进行简化设计，并完成建模。

### 2.8 桥梁纠偏模块

**设计目标**：提升通过桥梁时的稳定性，防止掉落。

**技术选型与实现**：

- **传感器**：在排斥铲斗下方安装两个横向间隔 **14.5cm** 的 **KW8-3 碰撞传感器**，用于检测车体是否偏离桥梁。
- **双重功能**：
    - **辅助轮**：传感器碰撞末端设有小型导轮。当车体在桥上时，传感器被压回，导轮起到辅助支撑作用。
    - **侧向限位**：当车体一侧偏离桥梁时，该侧传感器会因失去支撑而伸出，触发纠偏逻辑，同时在物理上起到一定的限位作用。

#### 开发日志

- **2025.10.7**：完成桥梁纠偏模块的基本设计与选材。

---

## 三、软件与控制系统

软件是机器人的灵魂，决定了其功能的实现质量与智能化水平。本章节将详细介绍电控系统的技术选型、核心功能实现及优化过程。

### 3.1 系统架构与技术选型

**硬件平台**：STM32F103C8T6 (ST-Link V2)
**开发工具**：STM32CubeMX + VSCode + EIDE + OpenOCD + Cortex-Debug

#### 3.1.1 操作系统：FreeRTOS vs 裸机

- **裸机轮询**：实现简单，但难以保证多任务实时性，尤其是在需要同时处理高频输入、电机控制和紧急避障的复杂场景下。
- **FreeRTOS**：支持任务优先级和队列通信，能够优雅地协调各个任务，确保关键任务（如碰撞检测）的优先执行。

**选择理由**：考虑到机器人需要同时处理 **50Hz 的手柄输入**、**100Hz 的电机控制** 和 **高优先级的碰撞检测**，FreeRTOS 的多任务调度机制是保证系统实时性和稳定性的不二之选。

#### 3.1.2 PS2 通信方式：软件 GPIO vs 硬件 SPI

| 方案 | 优点 | 缺点 | 适用性分析 |
| :--- | :--- | :--- | :--- |
| **GPIO** | 配置灵活，已有现成驱动 | CPU 开销较大 | 适合快速原型开发，但在多任务环境下会抢占宝贵的 CPU 资源。 |
| **SPI** | 硬件处理，性能消耗小 | 现有教程不适配双灯版 PS2 | 适合 CPU 资源紧张、需要高频轮询的场景。 |

**选择理由**：由于 FreeRTOS 下运行多个任务，且 PS2 轮询频率较高，为节省 CPU 资源，选择 **硬件 SPI** 方案。

### 3.2 核心功能实现

#### 3.2.1 PS2 远程控制

**设计目标**：稳定读取手柄数据，并将摇杆与按键信息实时解析，通过队列发送给相应任务。

**技术难点与解决方案**：

- **问题：SPI 模式错误**
    - **现象**：初始配置（CPHA=1Edge）导致连接器绿灯慢闪，通信不稳定。
    - **解决方案**：查阅资料后确认，双灯版 PS2 需将 SPI 模式配置为 **CPHA = 2 Edge**。修改后通信恢复正常。
- **问题：摇杆数据解析**
    - **现象**：摇杆原始数据范围为 0–255，不便于直接用于差速控制。
    - **解决方案**：将数据映射到 **-128 ~ +127** 的范围，0点居中，便于进行速度和方向的计算。

**FreeRTOS 任务设计**：

- **任务名**：`ps2Task`
- **优先级**：`AboveNormal`，确保输入响应的及时性。
- **数据流**：
    - 摇杆数据 → `motorQueue01` (底盘电机)
    - L1/L2 肩键 → `servoQueue` (转移舱门)
    - R1/R2 肩键 → `motorQueue02` (承接漏斗)
    - 〇 键 → `lockModeQueue` (防挤压驻守)

#### 3.2.2 双电机驱动与差速转向

**设计目标**：实现左右履带的独立控制，支持差速转向，并具备“主动刹车”功能以避免惯性滑行。

**技术实现**：

- **PWM 控制**：使用 TIM 输出 **1kHz** 的 PWM 信号驱动 L298N，该频率可有效避免电机啸叫。
- **主动刹车逻辑**：当摇杆回中，速度指令为0时，将对应的 IN1 和 IN2 引脚同时置为高电平，形成 **短路制动**。这使得电机立即停止，而不是随惯性滑行，极大地提升了操控精度。
- **摇杆死区**：设置 **±10** 的摇杆死区，避免因手柄摇杆的物理抖动导致电机产生不必要的微动。

#### 3.2.3 转移舱门舵机控制

**设计目标**：通过 L1/L2 按键控制后舱门的开合，支持连续转动。

**技术实现**：

- **PWM 输出**：使用 TIM1 CH1 输出 **50Hz** 的 PWM 信号控制 SG90 舵机。
- **角度映射**：将 0° 映射为 0.5ms 脉宽，180° 映射为 2.5ms 脉宽。
- **连续转动与冲突保护**：
    - **优化前**：按键单次触发，控制不连续。
    - **优化后**：改为 **长按时持续转动**，每 10ms 调整 2°。同时，当 L1 和 L2 被同时按下时，判定为逻辑冲突，舵机停止动作。

#### 3.2.4 实体碰撞检测与桥梁纠偏

**设计目标**：在通过桥梁时，一旦检测到一侧悬空，立即自动纠偏，防止掉落。该功能需具备高优先级和高可靠性。

**技术难点与解决方案**：

- **问题：中断抖动严重**
    - **现象**：初始采用 GPIO EXTI 中断方案，但由于机械结构带来的物理抖动，导致中断被频繁触发，逻辑混乱。
    - **解决方案**：改为 **10ms 软件轮询**，并结合 **50ms 的防抖计时**。即连续 5 次（50ms）检测到相同状态后，才确认状态有效，有效过滤了抖动干扰。
- **问题：逻辑反转**
    - **现象**：微动开关为 **NO (Normally Open)** 型，导致检测逻辑与预期完全相反。
    - **解决方案**：在确认硬件特性后，修正了软件中的判断条件。
- **问题：纠偏动作卡顿**
    - **现象**：检测到悬空后，直接将一侧电机速度降为0，导致车体产生剧烈冲击，动作不平滑。
    - **解决方案**：引入 **“目标速度 + 平滑过渡”** 算法。当需要纠偏时，将目标速度设定为原速度的 **40%**，然后每 10ms 将当前速度向目标速度调整 **12%**。这使得减速过程变得平滑，车体姿态更稳定。

**参数调优**：

- **减速比例**：经过 60% → 30% → **40%** 的实测对比，40% 的减速比例既能实现快速纠偏，又不会产生过大的转向惯性。
- **平滑步长**：经过 5% → 20% → **12%** 的测试，12% 的步长在响应速度和平滑度之间取得了最佳平衡。

#### 3.2.5 防挤压驻守模式（圆圈键锁止）

**背景**：在高台等关键位置驻守时，需要一种模式能抵抗外力推动，保持原地不动。

**需求演变与技术迭代**：

1.  **v1.0 - 5Hz 瞬间正反转**
    - **实现**：每 200ms 在满速正转和满速反转之间切换。
    - **问题**：切换频率过快，机械冲击剧烈，噪音极大，且对电机和传动结构损害严重。

2.  **v1.1 - 2Hz 平滑过渡**
    - **实现**：周期延长至 500ms，并引入平滑加速/减速。
    - **问题**：虽然冲击减小，但缺少“锁止”的感觉，更像是在原地“抽搐”。

3.  **v2.0 - 三阶段平滑控制（最终方案）**
    - **设计思想**：将一个完整的锁止周期（2秒）分为 **加速 → 减速 → 零速停留** 三个阶段，模拟一种“对抗-释放-再对抗”的节奏，既有锁止力，又平滑。
    - **技术实现**：
        - **状态机**：使用 `lockPhase` 变量追踪当前所处阶段（0=加速, 1=减速, 2=停留）。
        - **线性插值**：在加速和减速阶段，每 10ms 更新一次速度值，确保速度变化平滑。
        - **低速运行**：为降低能耗和噪音，将最大速度限制在 **±64**（约50%功率）。
        - **零速停留**：在每个周期的末尾增加一个 **500ms** 的零速阶段，让机械结构有时间完全释放应力，提升了锁止的稳定性。
    - **优先级**：该功能由〇键触发，在逻辑上拥有最高优先级，会覆盖摇杆的输入。

**关键参数选择理由**：

- **速度 64 (非 127)**：在提供足够锁止力的同时，避免了高速切换带来的剧烈抖动和巨大噪音。
- **阶段时长 500ms**：在 10ms 的任务周期下，每个阶段包含 50 次插值计算，足以保证速度曲线的平滑。

---

## 四、系统集成与性能评估

### 4.1 系统资源占用

| 资源类型 | 使用量 | 总量 | 占用率 | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| **RAM** | 6.8 KB | 20 KB | 34.0% | 包含任务栈、FreeRTOS 堆及全局变量，余量充足。 |
| **任务数** | 5 | - | - | `ps2Task`, `servoTask`, `motorTask01`, `motorTask02`, `collisionTask01` |
| **队列数** | 3 | - | - | `motorQueue01`, `motorQueue02`, `servoQueue` |

**分析**：系统资源利用率均衡，RAM 占用在安全范围内，为后续功能扩展留有余地。

### 4.2 实时性与响应速度

| 功能模块 | 周期/频率 | 响应时间 | 说明 |
| :--- | :--- | :--- | :--- |
| **PS2 数据采样** | 20ms / 50Hz | < 25ms | 保证输入无明显延迟。 |
| **电机控制** | 10ms / 100Hz | < 15ms | 控制平滑，无抖动。 |
| **舵机控制** | 10ms / 100Hz | < 20ms | 连续转动，响应及时。 |
| **碰撞检测** | 10ms 轮询 + 50ms 防抖 | < 60ms | 足够在掉落前完成纠偏。 |
| **停车响应** | - | < 50ms | 主动刹车效果显著，定位精准。 |
| **圆圈键锁止** | 2s 周期 | < 10ms | 状态切换迅速，过渡平滑。 |

**分析**：所有关键任务均在 **100ms** 内响应，满足实时性要求。特别是主动刹车和碰撞检测的优化，极大地提升了机器人的操控性和安全性。

### 4.3 控制精度与操纵体验

- **摇杆死区**：**±10** 的死区设定有效过滤了手柄摇杆的物理抖动。
- **电机平滑过渡**：**12%/10ms** 的速度调整步长，使得加速和减速过程自然流畅。
- **自动纠偏**：通过差速实现自然转向，无需停车，整个过程一气呵成。
- **圆圈键锁止**：三阶段控制策略在保证锁止效果的同时，兼顾了平滑性和低能耗，体验良好。

---

## 五、总结与反思

### 5.1 成功经验

1.  **FreeRTOS 的正确应用**：合理的任务划分和优先级设计是保证系统实时性的基石。
2.  **平滑过渡算法的重要性**：在电机控制中引入平滑过渡，是提升用户体验的关键。
3.  **轮询在特定场景下优于中断**：面对严重的物理抖动，带有软件防抖的轮询方案比硬件中断更可靠。
4.  **迭代式开发**：从“能用”到“好用”的转变，离不开基于实际测试反馈的持续迭代。圆圈键锁止功能的四次迭代便是最佳例证。

### 5.2 不足与改进方向

1.  **避障策略单一**：目前的纠偏策略仅支持减速转向，未来可加入后退、旋转等更复杂的避障动作。
2.  **状态反馈缺失**：缺少 LED 或蜂鸣器等状态指示，为调试和使用带来不便。
3.  **代码规范**：部分早期代码的注释和命名风格有待统一。

### 5.3 技术启示

- **确认硬件特性是前提**：如开关的 NO/NC 逻辑，错误的假设会导致整个软件逻辑的颠覆。
- **参数调优必须基于实测**：理论计算的参数往往与实际表现有差距，唯有通过实验才能找到最佳值。
- **用户体验至上**：一个 50ms 的平滑过渡，或是一个 0.5s 的零速停留，这些看似微小的细节，却能极大地影响最终的操-控感受。